<!-- templates/customer.html -->
{% extends "base.html" %}
{% block title %}{{ t('title') }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="card-wrapper">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            ‚õ∏Ô∏è {{ t('title') }}
        </h1>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">üì± {{ t('how_it_works') }}:</h3>
            <ol class="list-decimal list-outside text-sm text-blue-700 space-y-1 pl-6">
                <li>{{ t('step_1_fill_details') }}</li>
                <li>{{ t('step_2_get_sms') }}</li>
                <li>{{ t('step_3_write_code') }}</li>
                <li>{{ t('step_4_pay_sms') }}</li>
                <li>{{ t('step_5_pickup_sms') }}</li>
            </ol>
        </div>

        <form action="{{ url_for('customer.request_ticket') }}" method="POST" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ t('your_name') }} *
                </label>
                <input type="text" name="name" id="name" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="{{ t('your_name_placeholder') }}">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ t('phone_label') }} *
                </label>
                <input type="tel" name="phone" id="phone" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="+45 {{ t('phone_placeholder') }}">
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="font-semibold text-yellow-800 mb-3">{{ t('your_skate_details') }} *</h3>
                <p class="text-sm text-yellow-700 mb-4">
                    {{ t('exact_details_warning') }}
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('skate_brand') }} *</label>
                        <select name="brand" id="brand" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white">
                            <option value="">{{ t('select_brand') }}</option>
                            {% for brand_key, brand_value in brands %}
                                <option value="{{ brand_value }}">{{ t('brand_' + brand_key) }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('skate_color') }} *</label>
                        <select name="color" id="color" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white">
                            <option value="">{{ t('select_color') }}</option>
                            {% for color_key, color_value in colors %}
                                <option value="{{ color_value }}">{{ t('color_' + color_key) }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span id="size-label">{{ t('skate_size') }}</span> *
                            <span id="edea-indicator" class="text-xs text-blue-600 hidden">{{ t('edea_size_indicator') }}</span>
                        </label>
                        <select name="size" id="size" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white">
                            <option value="">{{ t('select_size') }}</option>
                            {% for size in sizes %}
                                <option value="{{ size }}" data-size-type="standard">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full btn-primary text-lg" id="submit-btn">
                üì± {{ t('submit_button') }}
            </button>
        </form>

        <div class="mt-6 text-center text-sm text-gray-600">
            <p>üí° {{ t('payment_link_info') }}</p>
            <p>‚ö†Ô∏è {{ t('payment_required_info') }}</p>
        </div>
    </div>
</div>

<script>
// EDEA size data
const edeaSizes = {{ edea_sizes | tojson }};
const standardSizes = {{ sizes | tojson }};

// Dynamic size switching based on brand
document.addEventListener('DOMContentLoaded', function() {
    const brandSelect = document.getElementById('brand');
    const sizeSelect = document.getElementById('size');
    const edeaIndicator = document.getElementById('edea-indicator');

    function updateSizeOptions(isEdea) {
        const currentValue = sizeSelect.value;
        const sizes = isEdea ? edeaSizes : standardSizes;

        // Clear current options except the placeholder
        sizeSelect.innerHTML = '<option value="">{{ t("select_size") }}</option>';

        // Add appropriate size options
        sizes.forEach(function(size) {
            const option = document.createElement('option');
            option.value = size;
            option.textContent = size;
            option.setAttribute('data-size-type', isEdea ? 'edea' : 'standard');
            sizeSelect.appendChild(option);
        });

        // Show/hide EDEA indicator
        if (isEdea) {
            edeaIndicator.classList.remove('hidden');
        } else {
            edeaIndicator.classList.add('hidden');
        }

        // Try to restore value if it's still valid
        if (currentValue && sizes.includes(parseInt(currentValue))) {
            sizeSelect.value = currentValue;
        }
    }

    // Listen for brand changes
    brandSelect.addEventListener('change', function() {
        const isEdea = this.value === 'EDEA';
        updateSizeOptions(isEdea);
    });

    // Initialize on page load
    if (brandSelect.value === 'EDEA') {
        updateSizeOptions(true);
    }

    // localStorage persistence for form fields
    const fields = ['phone', 'name', 'brand', 'color', 'size'];

    // Check if localStorage is available
    if (typeof(Storage) === "undefined") {
        console.log("localStorage not supported");
        return;
    }

    // Load saved values from localStorage
    fields.forEach(function(fieldName) {
        const field = document.getElementById(fieldName);
        const savedValue = localStorage.getItem('skate_form_' + fieldName);
        if (field && savedValue) {
            field.value = savedValue;
            console.log('Restored ' + fieldName + ': ' + savedValue);

            // If brand was restored, update size options
            if (fieldName === 'brand' && savedValue === 'EDEA') {
                updateSizeOptions(true);
            }
        }
    });

    // Save values to localStorage on input
    fields.forEach(function(fieldName) {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('input', function() {
                localStorage.setItem('skate_form_' + fieldName, field.value);
            });
            field.addEventListener('change', function() {
                localStorage.setItem('skate_form_' + fieldName, field.value);
            });
        }
    });
});

{% if recaptcha_site_key %}
// reCAPTCHA v3 integration
document.getElementById('submit-btn').addEventListener('click', function(e) {
    e.preventDefault();
    
    var form = document.querySelector('form');
    
    // Check HTML5 form validity first
    if (!form.checkValidity()) {
        // Show validation messages by triggering native validation
        form.reportValidity();
        return;
    }

    grecaptcha.ready(function() {
        grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'ticket_request'}).then(function(token) {
            // Add the token to the form
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'g-recaptcha-response';
            input.value = token;
            form.appendChild(input);

            // Submit the form
            form.submit();
        });
    });
});
{% endif %}
</script>

<style>
/* Custom dropdown arrow with proper spacing */
select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
}
</style>
{% endblock %}
