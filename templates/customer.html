<!-- templates/customer.html -->
{% extends "base.html" %}
{% block title %}{{ t('title') }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            ‚õ∏Ô∏è {{ t('title') }}
        </h1>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">üì± {{ t('how_it_works') }}:</h3>
            <ol class="list-decimal list-outside text-sm text-blue-700 space-y-1 pl-6">
                <li>{{ t('step_1_fill_details') }}</li>
                <li>{{ t('step_2_get_sms') }}</li>
                <li>{{ t('step_3_write_code') }}</li>
                <li>{{ t('step_4_pay_sms') }}</li>
                <li>{{ t('step_5_pickup_sms') }}</li>
            </ol>
        </div>

        <form action="{{ url_for('request_ticket') }}" method="POST" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ t('your_name') }} *
                </label>
                <input type="text" name="name" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Enter your full name">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    {{ t('phone_label') }} *
                </label>
                <input type="tel" name="phone" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="+45 12 34 56 78">
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="font-semibold text-yellow-800 mb-3">{{ t('your_skate_details') }} *</h3>
                <p class="text-sm text-yellow-700 mb-4">
                    {{ t('exact_details_warning') }}
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('skate_brand') }} *</label>
                        <select name="brand" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">{{ t('select_brand') }}</option>
                            {% for brand_key, brand_value in brands %}
                                <option value="{{ brand_value }}">{{ t('brand_' + brand_key) }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('skate_color') }} *</label>
                        <select name="color" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">{{ t('select_color') }}</option>
                            {% for color_key, color_value in colors %}
                                <option value="{{ color_value }}">{{ t('color_' + color_key) }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('skate_size') }} *</label>
                        <select name="size" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">{{ t('select_size') }}</option>
                            {% for size in sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full btn-primary text-lg" id="submit-btn">
                üì± {{ t('submit_button') }}
            </button>
        </form>

        <div class="mt-6 text-center text-sm text-gray-600">
            <p>üí° {{ t('payment_link_info') }}</p>
            <p>‚ö†Ô∏è {{ t('payment_required_info') }}</p>
        </div>
    </div>
</div>

<script>
// localStorage persistence for form fields
document.addEventListener('DOMContentLoaded', function() {
    const fields = ['phone', 'customer_name', 'brand', 'color', 'size'];
    
    // Check if localStorage is available
    if (typeof(Storage) === "undefined") {
        console.log("localStorage not supported");
        return;
    }
    
    // Load saved values from localStorage
    fields.forEach(function(fieldName) {
        const field = document.getElementById(fieldName);
        const savedValue = localStorage.getItem('skate_form_' + fieldName);
        if (field && savedValue) {
            field.value = savedValue;
            console.log('Restored ' + fieldName + ': ' + savedValue);
        }
    });
    
    // Save values to localStorage on input
    fields.forEach(function(fieldName) {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('input', function() {
                localStorage.setItem('skate_form_' + fieldName, field.value);
            });
            field.addEventListener('change', function() {
                localStorage.setItem('skate_form_' + fieldName, field.value);
            });
        }
    });
});

{% if recaptcha_site_key %}
// reCAPTCHA v3 integration
document.getElementById('submit-btn').addEventListener('click', function(e) {
    e.preventDefault();
    
    var form = document.querySelector('form');
    
    // Check HTML5 form validity first
    if (!form.checkValidity()) {
        // Show validation messages by triggering native validation
        form.reportValidity();
        return;
    }

    grecaptcha.ready(function() {
        grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'ticket_request'}).then(function(token) {
            // Add the token to the form
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'g-recaptcha-response';
            input.value = token;
            form.appendChild(input);

            // Submit the form
            form.submit();
        });
    });
});
{% endif %}
</script>
{% endblock %}
